(function(a,b){define(["underscore","backbone","IO/BackendSocket","IO/MessageRouterMixin"],function(b,c,d,e){var f=b.extend(function(){},c.Events);e.mixin(f),f.Backend=b.extend(function(){},c.Events),e.mixin(f.Backend),f.Backend.socket=new d("wdjs://window/events"),f.Backend.socket.onmessage=function(a){f.Backend.trigger("message",a)},f.Backend.requestAsync=function(b,c){var d=$.Deferred();typeof b!="string"&&(c=b,b=c.url);var e=b;c=c||{},c.type=c.type||"get",c.data=c.data||{};var f=function(b){b=JSON.parse(b),b.state_line=b.state_line||b.state_code,c.success&&c.success.call(a,b),d.resolve(b)};switch(c.type.toLowerCase()){case"get":var g=[],h;for(h in c.data)g.push(h+"="+a.encodeURIComponent(c.data[h]));g.length>0&&(b+="?"+g.join("&")),a.OneRingRequest(c.type,b,null,f);break;case"post":a.OneRingRequest(c.type,b,a.encodeURIComponent(JSON.stringify(c.data)),f)}return d.promise()},f.Cloud=b.extend(function(){},c.Events),e(f.Cloud),f.Cloud.requestAsync=$.ajax,f.requestAsync=function(a,b){var c=typeof a=="string"?a:a.url;return/^wdj:/.test(c)?f.Backend.requestAsync.apply(f.Backend,arguments):f.Cloud.requestAsync.apply(f.Cloud,arguments)},f.Backend.on("message",function(a){f.trigger("message",b.extend(a,{source:"backend"}))}),f.Cloud.on("message",function(a){f.trigger("message",b.extend(a,{source:"cloud"}))});if(c&&c.sync){var g={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};c.sync=function(a,b,c){var d=b.url,e={url:b.url,type:g[a],contentType:"application/json",data:b.data||{},dataType:"json",processData:!1,success:c.success,error:c.error};f.requestAsync(d,e)}}return f})})(this)